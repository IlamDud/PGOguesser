<!DOCTYPE html>
<html>
<head>
    <title>Pokémon GO Regional Guesser</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 12px;
            font-family: Arial, sans-serif;
        }

        #image-container {
            width: 100%;
            height: min(60vh, 520px);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #00000008;
            border-radius: 12px;
        }

        #filename,
        #score,
        #high-score,
        #feedback,
        #secret-status {
            text-align: center;
            margin: 10px auto;
            font-size: 1.1rem;
        }

        /* Guess input + dropdown wrapper */
        #guess-wrap {
            width: min(520px, 92vw);
            margin: 10px auto;
        }

        #guess-input {
            width: 100%;
            padding: 12px;
            font-size: 1.05rem;
        }

        #guess-button,
        #try-again-button,
        #secret-button {
            display: block;
            width: min(520px, 92vw);
            margin: 10px auto;
            padding: 12px;
            font-size: 1.05rem;
        }

        #secret-button {
            width: auto;          /* override full width */
            min-width: 200px;
            padding: 8px 14px;
            font-size: 0.95rem;
            margin: 8px auto;
        }

        /* Custom dropdown (in page flow, not overlay) */
        .dropdown {
            width: 100%;
            margin-top: 6px;
            border: 1px solid #00000022;
            border-radius: 10px;
            background: #fff;
            max-height: 240px;
            overflow-y: auto;
        }

        .dropdown-item {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
        }

        .dropdown-item:hover,
        .dropdown-item.active {
            background: #00000010;
        }

        @media (max-width: 600px) {
            #image-container {
                height: 48vh;
            }

            body {
                padding: 10px;
            }

            #guess-wrap,
            #guess-button,
            #try-again-button {
                width: 94vw;
                font-size: 1.05rem;
                padding: 12px;
            }

            /* Secret Hint button stays smaller on mobile */
            #secret-button {
                width: auto;
                min-width: 180px;
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div id="image-container"></div>

    <!-- Hint Modal -->
    <div id="hint-modal" style="
        display:none;
        position:fixed;
        inset:0;
        background: rgba(0,0,0,0.65);
        z-index:9999;
        align-items:center;
        justify-content:center;
        padding:16px;
    ">
        <div style="background:#fff; border-radius:12px; padding:12px; width:min(720px,96vw);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>Champion Hint</strong>
                <button onclick="closeHintModal()">Close</button>
            </div>
            <img id="hint-image" style="width:100%; margin-top:10px; border-radius:10px;">
        </div>
    </div>

    <!-- Guess input + dropdown -->
    <div id="guess-wrap">
        <input
            id="guess-input"
            placeholder="Guess the event..."
            autocomplete="off"
            oninput="onGuessInput()"
            onfocus="openDropdown()"
            onkeydown="handleGuessKey(event)"
        >
        <div id="event-dropdown" class="dropdown" style="display:none;"></div>
    </div>

    <button id="guess-button" onclick="submitGuess()">Guess</button>
    <button id="try-again-button" onclick="resetGame()" style="display:none;">Try Again</button>

    <button id="secret-button" onclick="useSecretUnlock()" style="display:none;">
        Use Secret Unlock
    </button>

    <div id="secret-status"></div>

    <div id="score">Score: 0</div>
    <div id="high-score">High Score: 0</div>
    <div id="feedback"></div>

    <script>
        let events = {};
        let secrets = {};
        let eventNames = [];

        let runPool = [];

        let currentEvent = "";
        let score = 0;
        let streak = 0;
        let secretUnlocks = 0;

        // Per-question hint cache
        let activeHintEvent = null;
        let activeHintImage = null;

        // Dropdown state
        let dropdownIndex = -1;

        Promise.all([
            fetch("regionals_merged.json").then(r => r.json()),
            fetch("secret_hints.json").then(r => r.json()).catch(() => ({}))
        ]).then(([eventData, secretData]) => {
            events = eventData;
            secrets = secretData || {};
            eventNames = Object.keys(events);;

            loadHighScore();
            initRunPool();
            nextImage();
            updateUI();
        });

        function initRunPool() {
            // Flatten all (event, img) pairs into one list
            runPool = [];

            for (const [eventName, frames] of Object.entries(events)) {
                if (!Array.isArray(frames) || frames.length === 0) continue;
                for (const img of frames) {
                    runPool.push({ event: eventName, img });
                }
            }

            // Fisher–Yates shuffle for true random order
            for (let i = runPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [runPool[i], runPool[j]] = [runPool[j], runPool[i]];
            }
        }

        function nextImage() {
            // If pool is empty (start of run or ran out), rebuild it
            if (!runPool || runPool.length === 0) {
                initRunPool();
            }

            // If still empty, nothing to show
            if (runPool.length === 0) {
                alert("No frames found in regionals_merged.json.");
                return;
            }

            // Pop gives us a unique frame for this run
            const pick = runPool.pop();

            currentEvent = pick.event;

            activeHintEvent = null;
            activeHintImage = null;

            document.getElementById("image-container").style.backgroundImage =
                `url("randomframes/${encodeURIComponent(pick.img)}")`;

            document.getElementById("guess-input").value = "";
            document.getElementById("feedback").innerText = "";
            document.getElementById("guess-button").style.display = "block";
            document.getElementById("try-again-button").style.display = "none";

            closeDropdown();
        }


        function submitGuess() {
            const guess = document.getElementById("guess-input").value;

            if (!(guess in events)) {
                alert("Pick an event from the list.");
                return;
            }

            if (guess === currentEvent) {
                score++;
                streak++;

                if (streak % 10 === 0) {
                    secretUnlocks++;
                    document.getElementById("feedback").innerText =
                        `${streak} in a row! Champion Hint unlocked.`;
                }

                nextImage();
            } else {
                streak = 0;
                secretUnlocks = 0;

                activeHintEvent = null;
                activeHintImage = null;

                document.getElementById("feedback").innerText =
                    `Good Effort! It was ${currentEvent}`;
                document.getElementById("guess-button").style.display = "none";
                document.getElementById("try-again-button").style.display = "block";
            }

            updateUI();
        }

        function useSecretUnlock() {
            if (activeHintEvent === currentEvent && activeHintImage) {
                openHintModal(activeHintImage);
                return;
            }

            if (secretUnlocks <= 0) return;

            const list = secrets[currentEvent];
            if (!Array.isArray(list) || list.length === 0) {
                document.getElementById("feedback").innerText =
                    "No champion hint for this event yet.";
                return;
            }

            secretUnlocks--;

            const img = list[Math.floor(Math.random() * list.length)];
            const encoded = "secrets/" + encodeURIComponent(img);

            activeHintEvent = currentEvent;
            activeHintImage = encoded;

            openHintModal(encoded);
            updateUI();
        }

        function openHintModal(src) {
            document.getElementById("hint-image").src = src;
            document.getElementById("hint-modal").style.display = "flex";
        }

        function closeHintModal() {
            document.getElementById("hint-modal").style.display = "none";
        }

        function updateUI() {
            document.getElementById("score").innerText = `Score: ${score}`;
            updateHighScore();

            const btn = document.getElementById("secret-button");
            const status = document.getElementById("secret-status");

            const hasCachedHint =
                activeHintEvent === currentEvent && !!activeHintImage;

            btn.style.display = (secretUnlocks > 0 || hasCachedHint) ? "block" : "none";
            btn.innerText = hasCachedHint ? "Reopen Hint" : "Use Special Hint";

            status.innerText = `Progress to special hint: ${streak%10}/10 - Special Hints: ${secretUnlocks}`;
        }

        function resetGame() {
            score = 0;
            streak = 0;
            secretUnlocks = 0;

            activeHintEvent = null;
            activeHintImage = null;

            initRunPool();
            updateUI();
            nextImage();
        }

        function loadHighScore() {
            const hs = Number(localStorage.getItem("highScore") || 0);
            const el = document.getElementById("high-score");
            el.innerText = `High Score: ${hs}`;
            el.style.color = "#000";
        }

        function updateHighScore() {
            const el = document.getElementById("high-score");
            const hs = Number(localStorage.getItem("highScore") || 0);

            if (score > hs) {
                localStorage.setItem("highScore", score);
                el.innerText = `High Score: ${score}`;
                el.style.color = "red";
            } else {
                el.innerText = `High Score: ${hs}`;
                el.style.color = "#000";
            }
        }

        /* Dropdown logic */

        function openDropdown() {
            renderDropdown(document.getElementById("guess-input").value);
        }

        function closeDropdown() {
            const dd = document.getElementById("event-dropdown");
            dd.style.display = "none";
            dd.innerHTML = "";
            dropdownIndex = -1;
        }

        function onGuessInput() {
            dropdownIndex = -1;
            renderDropdown(document.getElementById("guess-input").value);
        }

        function renderDropdown(filterText) {
            const dd = document.getElementById("event-dropdown");
            const q = (filterText || "").toLowerCase().trim();

            const filtered = eventNames.filter(name =>
                name.toLowerCase().includes(q)
            );

            if (filtered.length === 0) {
                closeDropdown();
                return;
            }

            dd.style.display = "block";
            dd.innerHTML = "";

            filtered.slice(0, 60).forEach((name, i) => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "dropdown-item";
                btn.textContent = name;

                // mousedown selects BEFORE input loses focus
                btn.addEventListener("mousedown", e => {
                    e.preventDefault();
                    selectDropdownItem(name);
                });

                btn.addEventListener("mouseenter", () => {
                    dropdownIndex = i;
                    highlightDropdown(dd.querySelectorAll(".dropdown-item"));
                });

                dd.appendChild(btn);
            });
        }

        function selectDropdownItem(name) {
            const input = document.getElementById("guess-input");
            input.value = name;
            closeDropdown();
            input.focus();
        }

        function handleGuessKey(e) {
            const dd = document.getElementById("event-dropdown");
            const items = dd.querySelectorAll(".dropdown-item");

            if (e.key === "Enter") {
                if (dd.style.display !== "none" && dropdownIndex >= 0) {
                    e.preventDefault();
                    items[dropdownIndex].dispatchEvent(
                        new MouseEvent("mousedown", { bubbles: true })
                    );
                    return;
                }
                submitGuess();
                return;
            }

            if (e.key === "Escape") {
                closeDropdown();
                return;
            }

            if (dd.style.display === "none" || items.length === 0) return;

            if (e.key === "ArrowDown") {
                e.preventDefault();
                dropdownIndex = Math.min(dropdownIndex + 1, items.length - 1);
                highlightDropdown(items);
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                dropdownIndex = Math.max(dropdownIndex - 1, 0);
                highlightDropdown(items);
            }
        }

        function highlightDropdown(items) {
            items.forEach((el, idx) => {
                el.classList.toggle("active", idx === dropdownIndex);
                if (idx === dropdownIndex) el.scrollIntoView({ block: "nearest" });
            });
        }

        document.addEventListener("click", e => {
            const wrap = document.getElementById("guess-wrap");
            if (!wrap.contains(e.target)) closeDropdown();
        });
    </script>
</body>
</html>
